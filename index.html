<!DOCTYPE html>
<html>
<head>
    <title> BE YOURSELF </title>

    <!-- meta -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" sizes="any" mask=""  href="./img/timg1.jpeg">
    <!-- css -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="http://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link rel="stylesheet" href="css/pace.css">
    <link rel="stylesheet" href="css/custom.css">
    <!-- js -->
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/pace.min.js"></script>
    <script src="js/modernizr.custom.js"></script>
</head>

<body>
<div class="container">
    <header id="site-header">
        <div class="row">
            <div class="col-md-4 col-sm-5 col-xs-8">
                <div class="logo">
                    <h1><a href="index.html">BE YOURSELF</a></h1>
                </div>
            </div><!-- col-md-4 -->
            <div class="col-md-8 col-sm-7 col-xs-4">
                <nav class="main-nav" role="navigation">
                    <div class="navbar-header">
                        <button type="button" id="trigger-overlay" class="navbar-toggle">
                            <span class="ion-navicon"></span>
                        </button>
                    </div>

                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                        <ul class="nav navbar-nav navbar-right">
                            <li class="cl-effect-11"><a href="index.html" data-hover="HOME">HOME</a></li>
                            <li class="cl-effect-11"><a href="full-width.html" data-hover="BLOG">BLOG</a></li>
                            <li class="cl-effect-11"><a href="about.html" data-hover="ABOUT">ABOUT</a></li>
                        </ul>
                    </div>
                </nav>
            </div><!-- col-md-8 -->
        </div>
    </header>
</div>

<div class="content-body">
    <div class="container">
        <div class="row">
            <main class="col-md-8">
                <article class="post post-1">
                    <header class="entry-header">
                        <div class="entry-meta">
                            <span class="post-category"><a href="#">BE YOURSELF </a></span>
                            <span ><a href="#"><time class="entry-date" datetime="2012-11-09T23:15:57+00:00">2020年01月09日</time></a></span>
                        </div>
                    </header>
                    <div class="entry-content clearfix">
                        <p style="text-align: center">
                            欢迎大家到此博客学习与交流，本博客以 GO语言为主题 其经验总结多为个人实际项目所得 欢迎技术大牛指点与批评。
                            邮箱：programKingdom@163.com
                        </p>
                    </div>
                </article>
                <article class="post post-2">
                    <div class="page-header">
                        <h1><small>GOLANG</small></h1>
                    </div>
                    <div class="panel panel-default ">
                        <div class="panel-heading">
                            <h3 class="panel-title">&nbsp; &nbsp; -- 反射 -- &nbsp; &nbsp; 话不多讲一个实例带你搞定！</h3>
                        </div>
                        <textarea name="" class="panel-body" id="" rows="20"  disabled="disabled" style="display: inline-block;width: 100% ; height: 100%;background-color: #f5f5f5;color: #212529">
    Go语言提供了一种机制，在编译时不知道类型的情况下，可更新变量，在运行时查看值，调用方法以及直接对他们的布局进行操作,这种机制称之为反射！

    --- GO START

    //存储分类存储信息
// if type == shop = GoodsCategory
// if type == news = articleCategory
type CategoryListInit struct {
	Id  		int 		`upd:"1" json:"id"`					//ID
	ServiceNum 	int			`upd:"1" json:"service_num"`		//服务号
	Recommend  	int			`upd:"recommend" json:"recommend"`  //是否推荐
	IsDelete  	int			`upd:"1" json:"isDelete"`			//是否删除
	Hide 	 	int			`upd:"hide" json:"hide"`
	PId			int			`upd:"pid" json:"pid"`
	Title		string		`upd:"title" json:"title"`
	Des 		string	 	`upd:"des" json:"des"`
	Ico 		string		`upd:"ico" json:"ico"`
	Types 		string		`upd:"types" json:"types"`
}

//更新语句结构体
type CaseEnd struct {
	W int
	T string
}

//定义返回信息结构体
type ReturnBasicMssage struct {Conn *gin.Context }

//方法体
func CategoryOperation(conn *gin.Context){
	var (
		basic 					ReturnBasicMssage   //总的执行方法
		msgInit					[]CategoryListInit  //总的接受信息体
		delSql,upSql,inSql 		string 	//删除 --> 更新 --> 插入
		sqlIn1,sqlIn2			string	//更新的内嵌语句(1) -->更新的内嵌语句(2)
		err						error	//错误
		upMsg					= make(map[string][]CaseEnd)	//更新信息的组合Map
		isDel,isUp,ok,isIn		bool // 是否有删除--> 是否有更新 -->判断Map是否存在字段 -->是否有插入
	)
	basic.Conn = conn
	//初始化数据 --->接受前端传递过来的JSON
	if err = basic.InitCustomerMssage(&msgInit);err != nil {
		basic.ReturnDetailMssage(500,err,errors.New("对不起,发生了未知错误!"))
		return
	}

	delSql 	=  `delete from yisu_nav where id in(`
	upSql  	=  `update yisu_nav SET `
	inSql	=  `insert into yisu_nav(title,des,ico,pid,types,service_num,hide,recommend) values`
	sqlIn1  = 	`(`

	for _, v := range msgInit {
		if v.Id != 0 {
			//删除操作
			if v.IsDelete == 1 {
				if isDel {
					delSql += `,?`
				} else {
					delSql += strconv.Itoa(v.Id)
				}

				isDel = true
				continue
			}
			var (
				caseEnd CaseEnd
			)

			//更新操作 组合更新Map
			for i:= 0; i < reflect.TypeOf(v).NumField();i++  {   //反射  返回字段数量
				flied := reflect.TypeOf(v).Field(i).Tag.Get("upd")		//获取 返回 该字段tag标签的名称
				vss := reflect.ValueOf(v)	//获取该字段值操作
				if flied != "1" && flied != "" {
					if _ ,ok = upMsg[flied];ok {
						caseEnd.W 			= 	v.Id
						if reflect.TypeOf(v).Field(i).Type.String() == "int"{		//获取该字段的类型并转成字符串打印出来
							caseEnd.T 			= 	strconv.Itoa(int(vss.Field(i).Int()))  //获取该字段的值
						}else {
							caseEnd.T 			= 	vss.Field(i).String() //获取该字段的值
						}
						upMsg[flied] 			= 	append(upMsg[flied],caseEnd)

					}else{
						upMsg[flied] 			= 	[]CaseEnd{}
						caseEnd.W 				= 	v.Id
						if reflect.TypeOf(v).Field(i).Type.String() == "int"{
							caseEnd.T 			= 	strconv.Itoa(int(vss.Field(i).Int()))
						}else {
							caseEnd.T 			= 	vss.Field(i).String()
						}
						upMsg[flied] = append(upMsg[flied],caseEnd)
					}
				}
			}

			if isUp {
				sqlIn1  += `,`+strconv.Itoa(v.Id)
			}else {
				sqlIn1  += strconv.Itoa(v.Id)
			}
			isUp	= true
		} else {

			//插入操作
			if isIn{
				inSql += `,('`+v.Title+`','`+v.Des+`','`+v.Ico+`',`+strconv.Itoa(v.PId)+`,'`+v.Types+`',`+basic.GetLoginMes().ServiceNum+`,`+
					strconv.Itoa(v.Hide)+`,`+strconv.Itoa(v.Recommend)+`)`
			}else {
				inSql += `('`+v.Title+`','`+v.Des+`','`+v.Ico+`',`+strconv.Itoa(v.PId)+`,'`+v.Types+`',`+basic.GetLoginMes().ServiceNum+`,`+
					strconv.Itoa(v.Hide)+`,`+strconv.Itoa(v.Recommend)+`)`
			}

			isIn = true
		}
	}
	sqlIn1	+= `)`
	delSql 	+= `)`

	//组合更新语句
	if isUp {
		num := 0
		for k, v := range upMsg {
			if num > 0 {
				sqlIn2 +=` , `+ k + `=CASE id `
				for _, v2 := range v {
					sqlIn2 += `WHEN `+strconv.Itoa(v2.W)+` THEN '`+v2.T+`'`
				}
				sqlIn2 +=` END`
			}else {
				sqlIn2 += k + `=CASE id `
				for _, v2 := range v {
					sqlIn2 += ` WHEN `+strconv.Itoa(v2.W)+` THEN '`+v2.T+`'`
				}
				sqlIn2 +=` END `
			}
			num ++
		}
		upSql += sqlIn2+` where id in `+sqlIn1
	}

	//执行删除语句
	if isDel{
		if _,err:=modle.Table("nav").Execute(delSql);err != nil {
			fmt.Println(err)
		}
	}

	//执行更新语句
	if isUp{
		if _,err:=modle.Table("nav").Execute(upSql);err != nil {
			fmt.Println(err)
		}
	}

	//执行插入语句
	if isIn{
		if _,err:=modle.Table("nav").Execute(inSql);err != nil {
			fmt.Println(err)
		}
	}

	//反馈信息
	basic.ReturnDetailMssage(200,errors.New("操作成功!"),errors.New("操作成功!"))
}

    --- GO END
</textarea>
                    </div>
                </article>
            </main>


            <aside class="col-md-4">
                <div class="widget widget-recent-posts">
                    <h3 class="widget-title">最新文章</h3>
                    <ul>
                        <li>
                            <a href="#">Django 博客开发入门教程：前言</a>
                        </li>
                        <li>
                            <a href="#">Django 博客使用 Markdown 自动生成文章目录</a>
                        </li>
                        <li>
                            <a href="#">部署 Django 博客</a>
                        </li>
                    </ul>
                </div>

                <div class="widget widget-category">
                    <h3 class="widget-title">分类</h3>
                    <ul>
                        <li>
                            <a href="#">Django 博客教程 <span class="post-count">(13)</span></a>
                        </li>
                        <li>
                            <a href="#">Python 教程 <span class="post-count">(11)</span></a>
                        </li>
                        <li>
                            <a href="#">Django 用户认证 <span class="post-count">(8)</span></a>
                        </li>
                    </ul>
                </div>

                <div class="widget widget-tag-cloud">
                    <h3 class="widget-title">标签云</h3>
                    <ul>
                        <li>
                            <a href="#">GOLANG</a>
                        </li>
                        <li>
                            <a href="#">LINUX</a>
                        </li>
                        <li>
                            <a href="#">GIT</a>
                        </li>
                        <li>
                            <a href="#">MYSQL</a>
                        </li>
                        <li>
                            <a href="#">MONGODB</a>
                        </li>
                        <li>
                            <a href="#">DOCKER</a>
                        </li>
                        <li>
                            <a href="#">ELASTICSEARCH</a>
                        </li>
                        <li>
                            <a href="#">KS8</a>
                        </li>
                    </ul>
                </div>
            </aside>
        </div>
    </div>
</div>
<footer id="site-footer">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <p class="copyright">&programKingdom@16.com 2020 - 01 - 09
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- Mobile Menu -->
<div class="overlay overlay-hugeinc">
    <button type="button" class="overlay-close"><span class="ion-ios-close-empty"></span></button>
    <nav>
        <ul>
            <li><a href="index.html">首页</a></li>
            <li><a href="full-width.html">博客</a></li>
            <li><a href="about.html">关于</a></li>
        </ul>
    </nav>
</div>

<script src="js/script.js"></script>

</body>
</html>
